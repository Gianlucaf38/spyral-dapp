# üéµ Spyral ‚Äì Modular Song Asset dApp

<p align="center">
  <img src="https://img.shields.io/badge/Solidity-0.8.x-363636?style=for-the-badge&logo=solidity" />
  <img src="https://img.shields.io/badge/Hardhat-Development-F7DF1E?style=for-the-badge&logo=ethereum" />
  <img src="https://img.shields.io/badge/Base-Sepolia-0052FF?style=for-the-badge&logo=ethereum" />
  <img src="https://img.shields.io/badge/Chainlink-Functions-2A5ADA?style=for-the-badge&logo=chainlink" />
  <img src="https://img.shields.io/badge/IPFS-Decentralized-65C2CB?style=for-the-badge&logo=ipfs" />
  <img src="https://img.shields.io/badge/FastAPI-Backend-009688?style=for-the-badge&logo=fastapi" />
  <img src="https://img.shields.io/badge/Node.js-Environment-339933?style=for-the-badge&logo=node.js" />
  <img src="https://img.shields.io/badge/Docker-Containerized-2496ED?style=for-the-badge&logo=docker" />
</p>

---

## Overview

**Spyral** is a modular Web3 architecture designed to manage the lifecycle of a musical asset represented as a dynamic NFT.

Each song is minted on-chain and progresses through a structured lifecycle:

1. **Upload**
2. **Collaborate**
3. **Register**
4. **Publish**
5. **Revenue Distribution**

The project demonstrates how blockchain can coordinate multi-party ownership, enforce deterministic state transitions, verify external publication via oracle infrastructure, and distribute revenue trustlessly.

It integrates:

- Smart contracts deployed on **Base Sepolia**
- **Chainlink Functions** for off-chain verification (Spotify + stream data)
- **IPFS** for decentralized metadata
- External **FastAPI server** for dynamic NFT metadata
- Web3 frontend interaction
- OpenSea marketplace compatibility

---

## Technology Stack

| Technology | Description |
|------------|-------------|
| Solidity | Smart contract language used to implement SongAsset and modular logic |
| Node.js | JavaScript runtime used for Hardhat, scripts, and development tooling |
| Hardhat | Ethereum development framework for compiling, testing, deploying |
| Base Sepolia | Ethereum-compatible testnet where contracts are deployed |
| Chainlink Functions | Decentralized oracle network for Spotify and stream data |
| IPFS | Decentralized storage layer for NFT metadata |
| FastAPI | Python backend for dynamic metadata generation |
| Python | Backend logic and Web3 interaction |
| Docker | API server containerization |
| Railway | Cloud deployment platform for API hosting |
| OpenSea | NFT marketplace integration |

---

## Repository Structure

```
spyral-dapp/
‚îÇ
‚îú‚îÄ‚îÄ contracts/
‚îÇ   ‚îú‚îÄ‚îÄ SongStorage.sol
‚îÇ   ‚îú‚îÄ‚îÄ SongLifecycleManagement.sol
‚îÇ   ‚îú‚îÄ‚îÄ SongOracleModule.sol
‚îÇ   ‚îú‚îÄ‚îÄ SongRoyaltiesModule.sol
‚îÇ   ‚îî‚îÄ‚îÄ SongAsset.sol
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ deploy.js
‚îÇ
‚îú‚îÄ‚îÄ test/
‚îÇ   ‚îú‚îÄ‚îÄ SongAsset.test.js
‚îÇ   ‚îî‚îÄ‚îÄ SongAssetOracleMock.test.js
‚îÇ
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ main.py
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile
‚îÇ
‚îî‚îÄ‚îÄ hardhat.config.js
```

---

## Smart Contract Architecture

The system follows a **modular inheritance pattern**, separating responsibilities across multiple layers.

### 1Ô∏è‚É£ SongStorage.sol

Pure storage layer.

Contains:

- `Song` struct
- `mapping(uint256 => Song)`
- Collaborator mappings
- Stream count
- Spotify ID
- Revenue balances

No business logic ‚Äî only state.

---

### 2Ô∏è‚É£ SongLifecycleManagement.sol

Implements the lifecycle state machine.

- Defines states (Upload ‚Üí Collaborate ‚Üí Register ‚Üí Publish ‚Üí Revenue)
- `advanceState(uint256 tokenId)`
- Transition validation
- Role enforcement

Ensures deterministic and secure progression.

---

### 3Ô∏è‚É£ SongOracleModule.sol

Handles Chainlink Functions integration.

- Sends request to Chainlink Router
- Stores pending request context
- Implements `fulfillRequest(...)`
- Updates:
  - Spotify publication status
  - Stream count

Bridges on-chain and off-chain worlds.

---

### 4Ô∏è‚É£ SongRoyaltiesModule.sol

Implements trustless revenue splitting.

- Stores collaborator percentages
- Accepts revenue deposits
- Splits funds proportionally
- Enables withdrawals

No intermediary required.

---

### 5Ô∏è‚É£ SongAsset.sol

Final contract combining all modules.

- ERC721 implementation
- `mintSong(address to, bytes32 audioHash)`
- Integrates storage, lifecycle, oracle, royalties

Main deployed contract on Base Sepolia.

---

## Storage Model

### üîπ On-Chain (Base Sepolia)

Stored in contract storage:

- Lifecycle state
- Collaborators & percentages
- Spotify ID
- Stream count
- Revenue balances
- Audio hash
- Token ownership

Provides immutability and trustless coordination.

---

### üîπ IPFS (Off-Chain)

Stored:

- Images of NFT states.

Metadata is dynamically generated by the FastAPI server and reflects real-time on-chain state.

---

## üåê External API Server

Implemented using:

- Python
- FastAPI
- Web3.py
- Docker
- Railway deployment

### Endpoint

```
GET /spyral/metadata/{tokenId}
```

Flow:

1. Validate token existence
2. Query contract:
   - `getSongData(tokenId)`
   - `getCollaborators(tokenId)`
3. Unpack on-chain data
4. Build dynamic JSON metadata
5. Return HTTP 200

Returns 404 if token does not exist.

Enables dynamic NFT rendering on marketplaces.

---

## üîó Oracle Flow (Chainlink Functions)

1. Contract sends request to Chainlink Router  
2. Router forwards to DON  
3. Off-chain JS fetches Spotify data  
4. DON returns response  
5. `fulfillRequest()` updates contract  

Implements a **pull-based oracle pattern**.

---

## Revenue Logic

Once publishing and streaming conditions are met:

- Anyone can deposit revenue
- Owner triggers split
- Collaborators withdraw their share

Fully on-chain and deterministic.

---

## Why Blockchain?

Compared to traditional client-server systems:

- Immutable lifecycle transitions  
- Trustless multi-party revenue splitting  
- Transparent collaboration  
- Verifiable oracle responses  
- No centralized payout authority  

---

## üîí Potential Improvements

- Upgradeable proxy pattern
- Advanced role-based access control
- Event indexing optimization
- Oracle retry & fallback strategy
- Automated IPFS pinning workflow
- Production-grade CI/CD pipeline
- Gas optimization audit

---

## Conclusion

Spyral is a full-stack Web3 architecture combining:

- Modular Solidity contracts
- Chainlink oracle infrastructure
- Dynamic NFT metadata
- Off-chain API orchestration
- Decentralized storage
- Trustless royalty distribution

Designed as an academically rigorous yet production-structured Web3 system.

---
